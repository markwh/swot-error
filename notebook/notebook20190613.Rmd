---
title: "notebook20190613"
author: "Mark Hagemann"
date: "6/13/2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

Figures for Bordeaux presentation


### Set up data

```{r}
# function to cache objects
push2slides <- function(object) {
  objstring <- rlang::as_string(enexpr(object))
  sprstring <- "~/Documents/swot-error/reports/slides/rdata-bordeaux/%s.RData"
  save(list = objstring, file = sprintf(sprstring, objstring))
}

save2slides <- function(plotobj, filename, width = 6, height = 4, dpi = 200) {
  sprstring <- "~/Documents/swot-error/reports/slides/fig-bordeaux/%s"
  filename = sprintf(sprstring, filename)
  ggsave(filename = filename, plot = plotobj, width = width, 
         height = height, dpi = dpi, units = "in")
}


exdir <- rodir(47)

# Node data, node id's
exnodedf0 <- rt_read(path(exdir, "rt.nc"))
# exnodeind1 <- 400
# exnodeinds <- exnodeind1 + 0:4
exnode1 <- 3249239 
exnodes <- exnode1 + 0:7

# Pixel cloud
expixc0 <- join_pixc(exdir, type = "inner") %>% 
  filter(node_index %in% exnodes)
  
exlat <- expixc0$latitude
exlon <- expixc0$longitude
bbox <- c(min(exlon), min(exlat), max(exlon), max(exlat))

exnodedf <- exnodedf0 %>% 
  filter(latitude >= min(exlat), latitude <= max(exlat),
         longitude >= min(exlon), longitude <= max(exlon))

# Prior nodes, centerlines
priorfile <- "D:/data/SWOT-prior/PriorDistributionFolder/netcdfV4/NA07.nc"
priornodedf0 <- priornode_read(priorfile, as_sf = FALSE)
priornodedf <- priornodedf0 %>% 
  mutate(node_id = as.factor(node_id)) %>% 
  filter(latitude >= min(exlat), latitude <= max(exlat),
         longitude >= min(exlon), longitude <= max(exlon))

expixc <- join_pixc(exdir, type = "outer") %>% 
  mutate(node_index = as.factor(node_index),
         classification = as.factor(classification))%>% 
  filter(latitude >= min(exlat), latitude <= max(exlat),
         longitude >= min(exlon), longitude <= max(exlon))
expixc2 <- join_pixc(exdir, type = "outer") %>% 
  mutate(node_index = as.factor(node_index),
         classification = as.factor(classification))%>% 
  filter(range_index >= min(expixc$range_index), 
         range_index <= max(expixc$range_index),
         azimuth_index >= min(expixc$azimuth_index), 
         azimuth_index <= max(expixc$azimuth_index))




exmap <- get_map(location = bbox, maptype = "satellite", source = "google")
ggmap(exmap)
```

### Info on Sacramento

```{r}
push2slides(exnodedf0)
```

Histogram 

```{r}
histgg <- exnodedf0 %>% 
  ggplot(aes(x = width)) +
  geom_histogram() +
  xlab("River Width (m)") +
  ggtitle(sprintf("Median width: %s m", round(median(exnodedf0$width))))
save2slides(histgg, "width-histogram.png")
```

Zoom in to part of Sacramento

```{r}
sacmap_full <- get_map(location = c(lon = median(exnodedf0$longitude),
                                    lat = median(exnodedf0$latitude)), zoom = 9, 
                       maptype = "terrain")

ggmap(sacmap_full) + 
  geom_point(aes(x = longitude, y = latitude), data = exnodedf0) +
  geom_rect(xmin = bbox[1], ymin = bbox[2], xmax = bbox[3], ymax = bbox[4], color = "red")
```



### Pixel assignment to node

```{r}
exmapgg <- ggmap(exmap)
save2slides(exmapgg, "exmap-base.png")

gg1 <- expixc2 %>% 
  ggplot(aes(x = range_index, y = azimuth_index, fill = classification)) + 
  geom_raster()
gg1
save2slides(gg1, "pixc-slantplane.png")


exmap_pixc <- ggmap(exmap) + 
  geom_point(aes(x = longitude, y = latitude, 
                 color = classification), 
             size = 4, alpha = 0.8,
             data = expixc) +
  scale_color_brewer(palette = "Set2")
save2slides(exmap_pixc, "exmap-pixc.png")
```

Now talk about prior db

```{r}

priormap_bbox <- with(priornodedf0, 
                      c(min(longitude), min(latitude), 
                        max(longitude), max(latitude)))
priormap_full <- get_map(location = priormap_bbox, 
                         zoom = 6, 
                       maptype = "toner")
priormapfull_gg <- ggmap(priormap_full) +
  geom_point(aes(x = longitude, y = latitude), 
             data = priornodedf0, size = 0.3, color = "blue")
save2slides(priormapfull_gg, "priormap-full.png")


# Prior nodes
ggmap(exmap) + 
  geom_point(aes(x = longitude, y = latitude, 
                 fill = node_id), 
             shape = 21, color = "yellow",
             size = 4, alpha = 0.8,
             data = priornodedf) +
  scale_fill_brewer(palette = "Set1")

ggmap()

ggmap(exmap) + 
  geom_point(aes(x = longitude, y = latitude, 
                 color = node_index), 
             size = 4, alpha = 0.7,
             data = expixc) +
  scale_color_brewer(palette = "Set1")

ggmap(exmap) + 
  geom_point(aes(x = longitude, y = latitude, 
                 color = classification), 
             size = 4, alpha = 0.8,
             data = filter(expixc, !is.na(node_index))) +
  scale_color_brewer(palette = "Set2")


gg2 <- gg1 + 
  geom_point(aes(color = node_index))
gg2
```



### Pixel aggregation to node

```{r}
expixc %>% 
  filter(classification == 4) %>% 
  ggplot(aes(x = along_reach, y = height)) + 
  geom_point(aes(color = node_index)) + 
  scale_color_brewer(palette = "Set1")

pixcdistdf <- expixc %>% 
  rename(node_id = node_index) %>% 
  group_by(node_id) %>% 
  summarize(along_reach = mean(along_reach))

exnodedf %>% 
  mutate(node_id = as.factor(node_id)) %>% 
  left_join(pixcdistdf, by = "node_id") %>% 
  ggplot(aes(x = along_reach, y = height, color = node_id)) + 
  geom_point(data = filter(expixc, classification == 4), color = NA) + 
  geom_pointrange(aes(ymin = height - height_u, ymax = height + height_u))
  
```

### Result is a shapefile

```{r}

```


### Node aggregation to reach

```{r}
exreachid <- unique(exnodedf$reach_id) + 1
exreachdf <- rt_read(path(exdir, "rt.nc"), "reaches")

reachlm <- exnodedf0 %>% 
  filter(reach_id == exreachid) %>% 
  add_nodelen() %>% 
  add_offset(exreachdf) %>%

  reach_height_lm(node_h = .$height, node_h_u = .$height_u, 
                  node_x = .$cumlen, loc_offset = .$loc_offset)

markstats::ggTermPlot(reachlm, xvar = "x")

```


```{r}


nodereachdf <- exnodedf0 %>% 
  add_nodelen(force = TRUE) %>%
  mutate(reach = as.factor(reach_id)) 

reachreachdf <- nodereachdf %>% 
  group_by(reach_id) %>% 
  summarize(cumlen = mean(cumlen)) %>% 
  right_join(exreachdf, by = "reach_id") %>% 
  mutate(reach = as.factor(reach_id))
  
  
nodereachdf %>% 
  ggplot(aes(x = cumlen, y = height, group = reach, color = reach)) +
  geom_point() +
  stat_smooth(method = "lm", color = "black", se = FALSE) +
  # geom_point(data = reachreachdf, size = 4, shape = 22, fill = "gray20")
  xlab("along-river distance (m)")

nodereachdf %>% 
  ggplot(aes(x = cumlen, y = height, group = reach, color = reach)) +
  geom_point(color = NA) +
  stat_smooth(method = "lm", se = FALSE) +
  # geom_point(data = reachreachdf, size = 4, shape = 22, fill = "gray20")
  xlab("along-river distance (m)") + 
  geom_rug(data = reachreachdf)

nodereachdf %>% 
  ggplot(aes(x = cumlen, y = height, group = reach, color = reach)) +
  geom_point(color = NA) +
  stat_smooth(method = "lm", se = FALSE) +
  # geom_point(data = reachreachdf, size = 4, shape = 22, fill = "gray20")
  xlab("along-river distance (m)") + 
  geom_rug(data = reachreachdf)

reachreachdf %>% 
  ggplot(aes(x = cumlen, y = height, color = reach, fill = reach)) + 
  geom_point(size = 4, shape = 22) +
  xlab("along-river distance (m)") + 
  geom_rug()


reachreachdf %>% 
  ggplot(aes(x = cumlen, y = slope, color = reach, fill = reach)) + 
  geom_point(size = 4, shape = 22) +
  ylab("slope (mm/km)")
```

